<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Radio News</title>
    <meta name="description" content="Stream the latest news from public radio stations across Germany, Denmark, Norway, Sweden, UK, and US">

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#2c3e50">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Radio News">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìª</text></svg>">

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <link rel="stylesheet" href="style.css">
    
    <!-- Early Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        // Hard refresh functionality with Ctrl+F5, Ctrl+R, or Ctrl+Shift+R
        document.addEventListener('keydown', function(event) {
            // Check for Ctrl+F5, Ctrl+R, or Ctrl+Shift+R
            if (event.ctrlKey && (event.key === 'F5' || event.key === 'r' || event.key === 'R')) {
                event.preventDefault();
                performHardRefresh();
            }
            // Alternative: Ctrl+Shift+R for hard refresh
            if (event.ctrlKey && event.shiftKey && (event.key === 'r' || event.key === 'R')) {
                event.preventDefault();
                performHardRefresh();
            }
        });

        function showHardRefreshOverlay() {
            const overlay = document.createElement('div');
            overlay.className = 'hard-refresh-overlay';
            overlay.innerHTML = `
                <div class="hard-refresh-content">
                    <div class="hard-refresh-spinner"></div>
                    <div class="hard-refresh-text">Hard Refresh in Progress</div>
                    <div class="hard-refresh-subtitle">Clearing caches and reloading all assets...</div>
                </div>
            `;
            document.body.appendChild(overlay);
            return overlay;
        }

        async function performHardRefresh() {
            console.log('üîÑ Performing hard refresh...');
            const overlay = showHardRefreshOverlay();
            const startTime = Date.now();
            
            try {
                // Small delay to show the overlay
                await new Promise(resolve => setTimeout(resolve, 500));
                
                console.log('üì± Unregistering service workers...');
                // Unregister service worker
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (let registration of registrations) {
                        await registration.unregister();
                        console.log('‚úÖ Service worker unregistered:', registration.scope);
                    }
                    console.log(`üéØ Unregistered ${registrations.length} service worker(s)`);
                } else {
                    console.log('‚ÑπÔ∏è Service Worker not supported');
                }

                console.log('üóëÔ∏è Clearing all caches...');
                // Clear all caches
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    let clearedCount = 0;
                    for (const cacheName of cacheNames) {
                        const deleted = await caches.delete(cacheName);
                        if (deleted) {
                            console.log('‚úÖ Cache cleared:', cacheName);
                            clearedCount++;
                        }
                    }
                    console.log(`üéØ Cleared ${clearedCount} cache(s)`);
                } else {
                    console.log('‚ÑπÔ∏è Cache API not supported');
                }

                console.log('üé® Refreshing CSS files...');
                // Force reload CSS files
                const cssLinks = document.querySelectorAll('link[rel="stylesheet"]');
                cssLinks.forEach((link, index) => {
                    const href = link.href.split('?')[0];
                    const newHref = href + '?t=' + Date.now();
                    link.href = newHref;
                    console.log(`‚úÖ CSS refreshed [${index + 1}]:`, href);
                });

                console.log('üîÑ Preparing page reload...');
                // Add cache-busting parameter to current URL and reload
                const url = new URL(window.location);
                url.searchParams.set('hardRefresh', Date.now());
                
                const duration = Date.now() - startTime;
                console.log(`‚ö° Hard refresh completed in ${duration}ms - reloading page...`);
                
                // Force reload the page bypassing cache
                window.location.replace(url.toString());
                
            } catch (error) {
                console.error('‚ùå Error during hard refresh:', error);
                console.error('Error stack:', error.stack);
                
                // Remove overlay on error
                if (overlay && overlay.parentNode) {
                    overlay.parentNode.removeChild(overlay);
                }
                
                // Show error message to user
                alert('Hard refresh failed. Falling back to regular reload.\nError: ' + error.message);
                
                // Fallback to regular hard reload
                console.log('üîÑ Falling back to regular hard reload...');
                window.location.reload(true);
            }
        }
    </script>
</head>
<body>
    <div class="container">
        <header>
            <h1 id="appTitle">üìª Global Radio News</h1>
            <p id="appDescription">Stream the latest news from public radio stations worldwide</p>
        </header>

        <main>
            <!-- Audio Player -->
            <div class="player-section">
                <div class="now-playing" id="nowPlaying">
                    <div class="station-info">
                        <div class="station-name" id="stationName">Select a station</div>
                        <div class="station-country" id="stationCountry"></div>
                    </div>
                </div>

                <audio id="audioPlayer" controls preload="none">
                    <p>Your browser doesn't support HTML5 audio. Please update your browser.</p>
                </audio>

                <div class="player-controls">
                    <button id="playPauseBtn" class="control-btn" disabled>
                        <span class="play-icon">‚ñ∂Ô∏è</span>
                        <span class="pause-icon" style="display: none;">‚è∏Ô∏è</span>
                    </button>
                    <button id="stopBtn" class="control-btn" disabled>‚èπÔ∏è</button>
                    <div class="volume-control">
                        <span>üîä</span>
                        <input type="range" id="volumeSlider" min="0" max="100" value="70">
                    </div>
                </div>
            </div>

            <!-- Mode Toggle -->
            <div class="mode-toggle">
                <button id="liveBtn" class="mode-btn active">üì° Live Streams</button>
                <button id="podcastBtn" class="mode-btn">üéß Latest News</button>
            </div>

            <!-- Station List -->
            <div class="stations-section" id="liveSection">
                <h2>Choose Your Live News Station</h2>
                <div id="stationsContainer">
                    <!-- Stations will be loaded dynamically from config -->
                </div>
            </div>

            <!-- Podcast Section -->
            <div class="podcast-section" id="podcastSection" style="display: none;">
                <h2>Latest News Programs</h2>
                <div class="play-all-container">
                    <button id="playAllPodcastsBtn" class="play-all-btn">üîÑ Play All News Podcasts</button>
                    <button id="clearPlayedHistoryBtn" class="clear-history-btn" title="Clear played episode history">üóëÔ∏è Clear History</button>
                </div>
                <div id="podcastsContainer">
                    <!-- Podcasts will be loaded dynamically from config -->
                </div>
            </div>

            <!-- Loading Indicator -->
            <div class="loading" id="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Connecting to station...</p>
            </div>

            <!-- Status Messages -->
            <div class="status-message" id="statusMessage"></div>
        </main>

        <footer>
            <p>Listen to live news streams from public radio stations worldwide. All streams are provided by their respective broadcasters.</p>
            <p class="disclaimer">Note: Stream availability may vary. Some stations may have geographic restrictions.</p>
            <p class="keyboard-shortcut">üí° Tip: Press <kbd>Ctrl+F5</kbd>, <kbd>Ctrl+R</kbd>, or <kbd>Ctrl+Shift+R</kbd> for hard refresh (clears all caches and forces reload of all assets)</p>
        </footer>
    </div>

    <script>
        // Add cache-busting for JS files if hard refresh was triggered
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('hardRefresh')) {
            console.log('üî• Hard refresh detected - loading assets with cache-busting...');
            const timestamp = Date.now();
            
            console.log('üìÑ Loading config.js with cache-busting...');
            const configScript = document.createElement('script');
            configScript.src = 'config.js?t=' + timestamp;
            configScript.onload = () => console.log('‚úÖ config.js loaded successfully');
            configScript.onerror = () => console.error('‚ùå Failed to load config.js');
            document.head.appendChild(configScript);
            
            console.log('üìÑ Loading script.js with cache-busting...');
            const mainScript = document.createElement('script');
            mainScript.src = 'script.js?t=' + timestamp;
            mainScript.onload = () => console.log('‚úÖ script.js loaded successfully - hard refresh complete!');
            mainScript.onerror = () => console.error('‚ùå Failed to load script.js');
            document.head.appendChild(mainScript);
            
            // Clean up URL after loading
            window.history.replaceState({}, document.title, window.location.pathname);
            console.log('üßπ URL cleaned up after hard refresh');
        } else {
            // Normal loading
            console.log('üìÑ Loading assets normally...');
            const configScript = document.createElement('script');
            configScript.src = 'config.js';
            configScript.onload = () => console.log('‚úÖ config.js loaded');
            configScript.onerror = () => console.error('‚ùå Failed to load config.js');
            document.head.appendChild(configScript);
            
            const mainScript = document.createElement('script');
            mainScript.src = 'script.js';
            mainScript.onload = () => console.log('‚úÖ script.js loaded');
            mainScript.onerror = () => console.error('‚ùå Failed to load script.js');
            document.head.appendChild(mainScript);
        }
    </script>
</body>
</html>
